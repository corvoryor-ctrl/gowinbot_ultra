name: Build macOS App

on:
  workflow_dispatch:
    inputs:
      project_dir:
        description: "à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œ (à¹€à¸Šà¹ˆà¸™ 20-09-68 à¸«à¸£à¸·à¸­à¹€à¸§à¹‰à¸™à¸§à¹ˆà¸²à¸‡à¸–à¹‰à¸²à¸­à¸¢à¸¹à¹ˆ root)"
        required: false
        default: ""
      entrypoint:
        description: "à¹„à¸Ÿà¸¥à¹Œà¹€à¸£à¸´à¹ˆà¸¡à¸£à¸±à¸™ (à¹€à¸Šà¹ˆà¸™ main.py à¸«à¸£à¸·à¸­ ai_service.py)"
        required: true
        default: "main.py"

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve working directory
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          REL="${{ github.event.inputs.project_dir }}"
          if [ -z "$REL" ]; then REL="."; fi
          echo "PROJECT_DIR_REL=$REL" >> "$GITHUB_ENV"
          echo "Using project dir: $REL"
          echo "== list project dir =="
          find "$REL" -maxdepth 2 -print

      - name: Verify entrypoint exists
        shell: bash
        working-directory: ${{ env.PROJECT_DIR_REL }}
        run: |
          set -euo pipefail
          EP="${{ github.event.inputs.entrypoint }}"
          if [ ! -f "$EP" ]; then
            echo "âŒ Entry point '$EP' not found in $(pwd)" >&2
            echo "ðŸ’¡ à¸•à¸£à¸§à¸ˆà¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¹ƒà¸«à¹‰à¸•à¸£à¸‡ à¹à¸¥à¹‰à¸§à¸à¸£à¸­à¸à¹ƒà¸™à¸Šà¹ˆà¸­à¸‡ entrypoint à¸•à¸­à¸™ Run workflow" >&2
            exit 1
          fi
          echo "ENTRYPOINT=$EP" >> "$GITHUB_ENV"
          echo "âœ… Found entrypoint: $EP"

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        working-directory: ${{ env.PROJECT_DIR_REL }}
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip wheel setuptools
          if [ -f requirements.txt ]; then
            pip install --only-binary=:all: numpy pandas scikit-learn || true
            pip install -r requirements.txt
          else
            pip install --only-binary=:all: numpy pandas scikit-learn || true
            pip install "fastapi>=0.110" "uvicorn[standard]>=0.30" "iqoptionapi>=0.1.6" \
                        "pandas-ta>=0.3.14b0" "joblib>=1.3" "python-machineid>=0.9.6" \
                        "PyNaCl>=1.5" "websocket-client>=1.6" "pydantic>=2.0"
          fi
          pip install pyinstaller

      - name: Build .app with PyInstaller
        shell: bash
        working-directory: ${{ env.PROJECT_DIR_REL }}
        run: |
          set -euo pipefail
          ICON_FLAG=""
          [ -f app.icns ] && ICON_FLAG="--icon app.icns"

          ADD=""
          for f in index.html market_hours.json actives.json ai_meta.json; do
            [ -e "$f" ] && ADD="$ADD --add-data \"$f:.\""
          done
          for d in models strategies services database; do
            [ -d "$d" ] && ADD="$ADD --add-data \"$d:$d\""
          done

          HIDE="--hidden-import pandas_ta --hidden-import sklearn --hidden-import iqoptionapi"

          echo "== pyinstaller args =="
          echo "ENTRYPOINT: ${{ env.ENTRYPOINT }}"
          echo "ICON: $ICON_FLAG"
          echo "ADD: $ADD"

          set -x
          eval pyinstaller --noconfirm --clean \
               --windowed \
               --name bot_app \
               $ICON_FLAG \
               $HIDE \
               $ADD \
               "${{ env.ENTRYPOINT }}"
          set +x

          ls -la dist || true

      - name: Upload app bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot_app_macos
          path: ${{ env.PROJECT_DIR_REL }}/dist/bot_app.app
